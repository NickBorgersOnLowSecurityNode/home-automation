#!/bin/bash
#
# Git pre-push hook
# This hook runs automated test validation before allowing a push.
# It executes the same tests that CI/CD will run to catch issues early.
#
# Installation: This hook is automatically installed by the devcontainer
# postCreateCommand. To manually install, run:
#   chmod +x .githooks/pre-push
#   ln -sf ../../.githooks/pre-push .git/hooks/pre-push
#

set -e  # Exit on any error

echo ""
echo "ğŸš€ Running pre-push hook..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

# Run the pre-push make target (matches CI exactly)
if make pre-push; then
    echo ""
    echo "âœ… Pre-push hook passed! Proceeding with push..."
    exit 0
else
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ Pre-push hook failed!"
    echo ""
    echo "Your push has been blocked because validation failed."
    echo "The pre-push hook runs the same checks as CI:"
    echo "  - Build check (go build ./...)"
    echo "  - All tests with race detector (go test -race ./...)"
    echo "  - Code coverage check (â‰¥70%)"
    echo ""
    echo "Please fix the issues above and try pushing again."
    echo ""
    echo "To skip this hook (NOT recommended), use: git push --no-verify"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
fi
